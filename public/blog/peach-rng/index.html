<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>understanding melee peach item pull rng logic</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Signika&display=swap" rel=stylesheet><style>body{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#3c4043;--text-pale-color:#9aa2b9;--bg-color:#fff;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f;--main-font:'Signika',ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:750px;--main-max-width:750px;--avatar-size:70px;--paragraph-font-size:18px;--paragraph-line-height:1.75;--aside-font-size:16px;--img-border-radius:0;--inline-code-border-radius:2px}body.dark{--primary-color:#698bcf;--primary-pale-color:#698bcf1c;--text-color:#9197a5;--text-pale-color:#5d6470;--bg-color:#202124;--highlight-mark-color:#5f75b045;--callout-note-color:#698bcf;--callout-important-color:#9971d9;--callout-warning-color:#c99054;--callout-alert-color:#d35757;--callout-question-color:#4985a2;--callout-tip-color:#3ea06f}</style><link href=/main.css rel=stylesheet><link href=/hl-light.css id=hl rel=stylesheet><body class=post><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark');const a=document.querySelector('link#hl');if(a)a.href='/hl-dark.css'}</script><header class=blur><div id=header-wrapper><nav><a href=/>djanatyn</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a href=/blog>blog</a><span class="wrap-separator fold">,</span><a class=fold href=/projects>projects</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/blog/feed.xml><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=wrapper><div id=blank></div><aside class=blur><nav><ul><li><a class=h2 href=#peach-pulls-mystery-items>peach pulls mystery items</a><li><a class=h2 href=#counting-turnips>counting turnips</a><li><a class=h2 href=#a-reddit-post-on-melee-rng>a reddit post on melee rng</a><li><a class=h2 href=#the-ssbm-datasheet>the ssbm datasheet</a><li><a class=h2 href=#enabling-dolphin-s-debugger>enabling dolphin's debugger</a><li><a class=h2 href=#finding-get-random-int>finding get_random_int</a><li><a class=h2 href=#logging-get-random-int-calls>logging get_random_int calls</a><li><a class=h2 href=#identifying-where-peach-rng-calls-happen>identifying where peach rng calls happen</a><li><a class=h2 href=#peach-downb-genturnip-logic>Peach_DownB_GenTurnip logic</a><li><a class=h2 href=#giving-peach-a-buff>giving peach a buff</a><li><a class=h2 href=#final-destination-no-items-beamswords-only>final destination, no items, beamswords only</a><li><a class=h2 href=#closing-thoughts>closing thoughts</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>understanding melee peach item pull rng logic</h1><div id=post-info><div id=date><span id=publish>2023-12-20</span></div></div><h1 id=peach-pulls-mystery-items>peach pulls mystery items<a aria-label="Anchor link for: peach-pulls-mystery-items" class=zola-anchor href=#peach-pulls-mystery-items>#</a></h1><p>as a melee peach player, i spend a lot of my time pulling random items out of the ground.<figure><img alt="gif of peach pulling a turnip" src=/img/peach-turnip-pull.gif><figcaption>image from ssbwiki</figcaption></figure><p>princess peach has a special move called <a rel="nofollow noreferrer" href=https://www.ssbwiki.com/Vegetable>"Vegetable"</a>, activated by pressing down-special while grounded. if peach is able to complete her pull animation successfully, she retrieves an item from the ground - either a turnip, a bobomb, a beamsword, or a mr saturn (with turnips being the most common). it's a defining move for her character, and for many players is the default option to consider when in a safe position. although she loses access to a few options while holding a turnip (most notably grab), the possibility of throwing it at an opponent demands respect. it can open up new approaches, enable otherwise impossible combo routes, and empowers her to interact with her opponent from a distance.<p>over the 20+ year history of the game, the community has created resources to help players understand how often to expect particular outcomes. this image is what i see referenced most often:<figure><img alt="table of peach item pull percentages" src=/img/expected-frequency-chart.png><figcaption>credit: Magus420</figcaption></figure><p>as shown above, not all pulls are equally likely. there are different kinds of turnips, and some turnips do more damage than others. some sequences of pulls are highly valuable, but extremely unlikely to occur - pulling two stitchfaces in a row (especially <a href="https://www.youtube.com/watch?v=rrzFeWC5kmc" rel="nofollow noreferrer">when you know how to use them</a>) is considered a special occassion. there are even advanced techniques like <a rel="nofollow noreferrer" href=https://smashboards.com/threads/postmodern-rng-tactics-knitting-panning-theory-discussion.414626/>knitting</a> that allow peach to continuously pull items faster than she could normally.<p>understanding how turnip rng works won't give you any competitive advantage in the game. but it is fun! so, let's continue.<h1 id=counting-turnips>counting turnips<a aria-label="Anchor link for: counting-turnips" class=zola-anchor href=#counting-turnips>#</a></h1><p>when playing melee online these days, it's common to record game records using the <a rel="nofollow noreferrer" href=https://github.com/project-slippi/slippi-wiki/blob/master/SPEC.md>SLP replay format</a>. these replays can be processed programmatically to collect statistics on the occurrence of specific events ingame.<p>previously, i had been very curious about whether <a rel="nofollow noreferrer" href=https://github.com/djanatyn/turnip-counter>my actual replay files matched up to the expected values </a> predicted by the chart above. at the time, <a rel="nofollow noreferrer" href=https://github.com/hohav>hohav</a> had already put together a rust crate called <a rel="nofollow noreferrer" href=https://github.com/hohav/peppi>peppi</a> which could process these replays. it didn't take very long to put together a program which would iterate over a directory of replay files, identify any peach item pulls that matched my character, and record them to a simple sqlite database:<pre class="language-sql z-code" data-lang=sql><code class=language-sql data-lang=sql><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TABLE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">IF NOT EXISTS </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">games</span></span> (
    id <span class="z-storage z-type z-sql">INTEGER</span> <span class="z-storage z-modifier z-sql">PRIMARY KEY</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    filename <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    start_time <span class="z-storage z-type z-sql">INTEGER</span>,
    p1_name <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    p1_code <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    p2_name <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    p2_code <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>
);

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TABLE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">IF NOT EXISTS </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">items</span></span> (
    id <span class="z-storage z-type z-sql">INTEGER</span> <span class="z-storage z-modifier z-sql">PRIMARY KEY</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    game_id <span class="z-storage z-type z-sql">INTEGER</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    item_id <span class="z-storage z-type z-sql">INTEGER</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    frame <span class="z-storage z-type z-sql">INTEGER</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    kind <span class="z-storage z-type z-sql">TEXT</span> <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    <span class="z-storage z-modifier z-sql">FOREIGN KEY</span> (game_id) <span class="z-storage z-modifier z-sql">REFERENCES</span> games (id)
);
</span></code></pre><p>even with a small sample of 3,505 pulls and 418 games, my results were very close to expectations:<pre class="language-sql z-code" data-lang=sql><code class=language-sql data-lang=sql><span class="z-source z-sql">sqlite<span class="z-keyword z-operator z-comparison z-sql">></span> <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-support z-function z-aggregate z-sql">COUNT</span>(<span class="z-variable z-language z-star z-sql">*</span>) <span class="z-keyword z-other z-DML z-sql">FROM</span> items;
<span class="z-constant z-numeric z-sql">3505</span>
sqlite<span class="z-keyword z-operator z-comparison z-sql">></span> <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-support z-function z-aggregate z-sql">COUNT</span>(<span class="z-variable z-language z-star z-sql">*</span>) <span class="z-keyword z-other z-DML z-sql">FROM</span> games;
<span class="z-constant z-numeric z-sql">418</span>
sqlite<span class="z-keyword z-operator z-comparison z-sql">></span> <span class="z-keyword z-other z-DML z-sql">SELECT</span> kind, CAST(<span class="z-support z-function z-aggregate z-sql">COUNT</span>(<span class="z-variable z-language z-star z-sql">*</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> <span class="z-storage z-type z-sql">REAL</span>) <span class="z-keyword z-operator z-math z-sql">/</span> (<span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-support z-function z-aggregate z-sql">COUNT</span>(<span class="z-variable z-language z-star z-sql">*</span>) <span class="z-keyword z-other z-DML z-sql">FROM</span> items) <span class="z-keyword z-other z-DML z-sql">FROM</span> items <span class="z-keyword z-other z-DML z-sql">GROUP BY</span> kind;
Beamsword      <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">00114122681883024</span> <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~0.11% actual vs 0.13% predicted
</span>Bobomb         <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">00228245363766049</span> <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~0.23% actual vs 0.26% predicted
</span>DotEyesTurnip  <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">0145506419400856</span>  <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~1.46% actual vs 1.71% predicted
</span>MrSaturn       <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">00485021398002853</span> <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~0.46% actual vs 0.39% predicted
</span>NormalTurnip   <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">888445078459344</span>   <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~88.84% actual vs 88.95% predicted (59.873 + 10.264 + 8.553 + 5.132 + 5.132)
</span>StitchTurnip   <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">0182596291012839</span>  <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~1.82% actual vs 1.71% predicted
</span>WinkyTurnip    <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">0704707560627675</span>  <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ~7.04% actual vs 6.84% predicted
</span></span></code></pre><p>but i was still curious. i had a chart of frequencies to expect, and i saw that my actual games were close to these expectations, but i still didn't understand how the game logic determined which item comes out of the ground.<h1 id=a-reddit-post-on-melee-rng>a reddit post on melee rng<a aria-label="Anchor link for: a-reddit-post-on-melee-rng" class=zola-anchor href=#a-reddit-post-on-melee-rng>#</a></h1><p>at some point, i encountered <a rel="nofollow noreferrer" href=https://www.reddit.com/r/SSBM/comments/71gn1d/the_basics_of_rng_in_melee/>a reddit post from september 2017 by twotwelvedegrees</a>, titled "The Basics of RNG in Melee". not only did this post explain the basics of melee's <a rel="nofollow noreferrer" href=https://en.wikipedia.org/wiki/Linear_congruential_generator>linear congruential generator</a> implementation, it also broke down the particular RNG calls which were executed for peach's item pulls:<blockquote><p>All random events in the game are controlled by the output of two functions: get_random_int(max_val) and get_random_float()...On any turnip pull Peach starts with a call to get_random_int(128) which proceeds as follows:</blockquote><table><thead><tr><th>Value<th>Result<tbody><tr><td>0<td>Peach pulls an item<tr><td>1-127<td>Peach pulls a turnip</table><blockquote><p>On pulling an item, there is then a call to get_random_int(6) which proceeds as follows:</blockquote><table><thead><tr><th>Value<th>Result<tbody><tr><td>0-1<td>Peach pulls a bomb<tr><td>2-4<td>Peach pulls a Mr. Saturn<tr><td>5<td>Peach pulls a beam sword</table><blockquote><p>On pulling a turnip, there is then a call to get_random_int(58) which proceeds as follows:</blockquote><table><thead><tr><th>Value<th>Result<tbody><tr><td>0-34<td>Peach pulls a regular turnip<tr><td>35-40<td>Peach pulls an unamused turnip<tr><td>41-45<td>Peach pulls a line eyes turnip<tr><td>46-48<td>Peach pulls a circle eyes turnip<tr><td>49-51<td>Peach pulls a super happy turnip<tr><td>52-55<td>Peach pulls a winky turnip<tr><td>56<td>Peach pulls a dot eyes<tr><td>57<td>Peach pulls a stitch</table><p>this was eye-opening for me. if i could analyze the code that was running while peach pulled an item, i could see (and provide a citation for) the conditional branches that were executed. i would no longer need to trust the chart - i could derive this information on my own. i was excited! and thankfully, much of the hard work had already been done for me.<h1 id=the-ssbm-datasheet>the ssbm datasheet<a aria-label="Anchor link for: the-ssbm-datasheet" class=zola-anchor href=#the-ssbm-datasheet>#</a></h1><p>in the very first paragraph, twotwelvedegrees mentions a spreadsheet:<blockquote><p>Major props to u/dansalvato and this spreadsheet since it basically did the research for me.</blockquote><p>this is the <a href="https://docs.google.com/spreadsheets/d/1JX2w-r2fuvWuNgGb6D3Cs4wHQKLFegZe2jhbBuIhCG8/preview#gid=19" rel="nofollow noreferrer">SSBM Data Sheet (1.02)</a>. it contains function addresses for many of the subroutines the game engine executes during normal gameplay. this document represents an extraordinary amount of effort reverse-engineering the game, made available for any curious hackers like myself.<p>one of the sections under the "Function Addresses" tab is labeled "Random Number Generator". the <code>get_random_int</code> function mentioned in the reddit post is described in some detail here:<ul><li>there is a main RNG function at <code>0x80380580</code>,<li>it's input is <code>r3</code>, which is the number of possible numbers to generate for the call,<li>it's output is <code>r3</code>, which is the random number returned</ul><p>if this is accurate, it means that every time peach attempts to pulls an item, we expect there's a call to <code>get_random_int(128)</code> at <code>0x80380580</code>. we should be able to load up our copy of melee, start the game, identify the function, and set some breakpoints to see it in action!<h1 id=enabling-dolphin-s-debugger>enabling dolphin's debugger<a aria-label="Anchor link for: enabling-dolphin-s-debugger" class=zola-anchor href=#enabling-dolphin-s-debugger>#</a></h1><p>i'm on nixos, so to load dolphin, i pull down a version from nixpkgs:<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">nix</span></span><span class="z-meta z-function-call z-arguments z-shell"> build nixpkgs#dolphin-emu<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> dolphin-hacking</span> <span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-colon z-shell">:</span></span><span class="z-meta z-function-call z-arguments z-shell"> get dolphin package</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">./dolphin-hacking/bin/dolphin-emu</span></span>                <span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-colon z-shell">:</span></span><span class="z-meta z-function-call z-arguments z-shell"> execute dolphin</span>
</span></code></pre><p>you're on your own for acquiring a copy of melee's disk image.<p>on my copy of dolphin, the debugging interface wasn't visible by default, so i had to enable it:<figure><img alt="screenshot of 'Enable Debugging UI' checkbox" src=/img/enable_debugging_ui.png><figcaption>Options > Configuration > Interface</figcaption></figure><p>i also toggled the 'Code', 'Registers', and 'Memory' pane into view:<figure><img alt="enabling 'Code', 'Registers', and 'Memory' view" src=/img/dolphin-view-settings.png><figcaption>View Toggles</figcaption></figure><p>i also moved some panes around:<figure><img alt="screenshot of dolphin debugger ui" src=/img/dolphin-ui.png><figcaption>ready for action</figcaption></figure><p>i've got an adapter for my gamecube controller setup, and i have a few gecko codes enabled which change the default behavior of the game to make investigation a little easier:<ul><li>Unlock All Characters and Stages<li>VS 1 player (set time to none)</ul><p>the game loads as expected, and we're at the character select screen:<figure><img alt="screenshot of melee running with debug pane to the side" src=/img/dolphin-debugger-game-running.png><figcaption>debugging activated</figcaption></figure><p>you might notice that all instructions are marked as <code>&LTunknown></code> while the game is running. if we hit the pause button, we can see the instructions:<figure><img alt="screenshot of instructions in debug pane" src=/img/dolphin-unpaused.png><figcaption>instructions are now visible</figcaption></figure><p>cool! we can see the address of each instruction, it's parameters, and there's even a callstack showing how we got here.<p>we already know where <code>get_random_int</code> is, so let's try searching for it.<h1 id=finding-get-random-int>finding get_random_int<a aria-label="Anchor link for: finding-get-random-int" class=zola-anchor href=#finding-get-random-int>#</a></h1><p>there's a "Search Address" text input available. typing in <code>0x80380580</code> and hitting enter will highlight the line for that address. we can right-click this line, select "Add Function" from the context menu, and we'll see a set of instructions highlighted:<figure><img alt="instructions for get_random_int" src=/img/add_function.png><figcaption>get_random_int assembly instructions</figcaption></figure><p>the name <code>zz_80380580_</code> is not very helpful. we can change that by right-clicking the same line, selecting "Rename symbol" from the context menu, and giving this symbol a better name, <code>get_random_int</code>.<p>we can even select "Copy function" in the context menu to get a listing for all of the instructions:<pre class=z-code><code><span class="z-text z-plain">get_random_int
80380580: lwz	r5, -0x570C (r13)
80380584: lis	r4, 0x0003
80380588: addi	r0, r4, 17405
8038058c: lwz	r4, 0 (r5)
80380590: mullw	r4, r4, r0
80380594: addis	r4, r4, 39
80380598: subi	r0, r4, 24893
8038059c: stw	r0, 0 (r5)
803805a0: lwz	r4, -0x570C (r13)
803805a4: lwz	r0, 0 (r4)
803805a8: rlwinm	r0, r0, 16, 16, 31 (ffff0000)
803805ac: mullw	r0, r3, r0
803805b0: srawi	r3, r0,16
803805b4: addze	r3, r3
803805b8: blr	
</span></code></pre><p>understanding what all of these instructions is outside the scope of this post. instead, let's ask dolphin to log every time this function is executed by adding a breakpoint!<h1 id=logging-get-random-int-calls>logging get_random_int calls<a aria-label="Anchor link for: logging-get-random-int-calls" class=zola-anchor href=#logging-get-random-int-calls>#</a></h1><p>first, let's enable the breakpoint view (i forgot to turn it on earlier):<figure><img alt="enabling breakpoints" src=/img/dolphin-view-breakpoints.png><figcaption>oops we need those</figcaption></figure><p>navigate to the breakpoint tab, click "New", and let's observe these calls as they execute:<figure><img alt="breakpoint configuration" src=/img/log-breakpoint.png><figcaption>breakpoint configuration</figcaption></figure><ul><li>activate this breakpoint at <code>0x80380580</code> (our suspected <code>get_random_int</code> function),<li>our condition <code>r3, 1</code> means to display the register <code>r3</code> in the log (which should be the range on numbers generated),<li>don't stop execution of the game, just log it</ul><p>it should look like this (it even includes our renamed symbol from earlier):<figure><img alt="configured breakpoint" src=/img/breakpoint-success.png><figcaption>configured breakpoint enabled</figcaption></figure><p>in melee, attempting to place the character select token when it isn't hovering over a particular character will select a random character - the random button is a modern innovation.<figure><img alt="randomly selecting characters" src=/img/random-characters.gif><figcaption>og random button</figcaption></figure><p>that random choice has to come from somewhere. in the log, we can actually see some <code>get_random_int</code> calls happening already:<pre class=z-code><code><span class="z-text z-plain">Breakpoint condition returned: 1. Vars:  r3=25
</span></code></pre><p><code>Vars: r3=25</code> sounds about right - there are 25 characters in the game!<blockquote class="callout alert"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M4.00098 20V14C4.00098 9.58172 7.5827 6 12.001 6C16.4193 6 20.001 9.58172 20.001 14V20H21.001V22H3.00098V20H4.00098ZM6.00098 20H18.001V14C18.001 10.6863 15.3147 8 12.001 8C8.68727 8 6.00098 10.6863 6.00098 14V20ZM11.001 2H13.001V5H11.001V2ZM19.7792 4.80761L21.1934 6.22183L19.0721 8.34315L17.6578 6.92893L19.7792 4.80761ZM2.80859 6.22183L4.22281 4.80761L6.34413 6.92893L4.92991 8.34315L2.80859 6.22183ZM7.00098 14C7.00098 11.2386 9.23956 9 12.001 9V11C10.3441 11 9.00098 12.3431 9.00098 14H7.00098Z" fill=currentColor></path></svg></div><div class=content><p>if you don't see any logs for breakpoints, check your logging configuration ("View" > "Show Logging Configuration") and try enabling all log types.</div></blockquote><h1 id=identifying-where-peach-rng-calls-happen>identifying where peach rng calls happen<a aria-label="Anchor link for: identifying-where-peach-rng-calls-happen" class=zola-anchor href=#identifying-where-peach-rng-calls-happen>#</a></h1><p>let's get ingame and try pulling a turnip! hit down-b, hit start to pause the game, and let's see what happened.<figure><img alt="screenshot of daisy pulling turnip" src=/img/pull-turnip.png><figcaption>daisy is the best peach costume</figcaption></figure><pre class=z-code><code><span class="z-text z-plain">...
Breakpoint condition returned: 1. Vars:  r3=128
Breakpoint condition returned: 1. Vars:  r3=58
...
</span></code></pre><p>nice:<ul><li><code>get_random_int(128)</code> is determining whether we pull an item or a turnip, and<li><code>get_random_int(58)</code> is determining the face of the turnip</ul><p>we're not logging the return value of the RNG call right now, but we've identified the <code>get_random_int</code> calls that are being executed when peach pulls an item. that's great progress!<p>what code is calling <code>get_random_int(128)</code>? let's modify our breakpoint with a different condition, and set it to break (not just log):<figure><img alt="new breakpoint condition" src=/img/modify-condition.png><figcaption>check for a specific argument</figcaption></figure><p>after pulling another turnip, the game should pause, stopping at <code>get_random_int</code>. interestingly, even though peach may have entered the item pull animation, the animation does not show which item peach has pulled, since it hasn't decided yet. let's check out our callstack:<figure><img alt="callstack screenshot" src=/img/link-register.png><figcaption>the path that led us here</figcaption></figure><p><code>LR</code> represents the <a rel="nofollow noreferrer" href=https://en.wikipedia.org/wiki/Link_register>"link register"</a>. whenever we call a subroutine with the <code>bl</code> instruction, we populate a special register with the address to return the program counter to once our subroutine finishes executing (usually with a <code>blr</code> instruction). if we click on the <code>LR = 8011d088</code> address, we can get some context on what's happening before this RNG call is executed, and what we do with the result.<p>this instruction is happening in the middle of the subroutine, so i scrolled up the previous <code>blr</code> instruction (denoting the end of the last subroutine), moved onto the next instruction (<code>0x8011d018</code>), and defined a new function as we did previously. i named it <code>turnip_rng_caller</code> - it may be used for other interactions, but we're fairly confident it's part of peach's item pull logic.<blockquote class="callout tip"><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M9.97308 18H11V13H13V18H14.0269C14.1589 16.7984 14.7721 15.8065 15.7676 14.7226C15.8797 14.6006 16.5988 13.8564 16.6841 13.7501C17.5318 12.6931 18 11.385 18 10C18 6.68629 15.3137 4 12 4C8.68629 4 6 6.68629 6 10C6 11.3843 6.46774 12.6917 7.31462 13.7484C7.40004 13.855 8.12081 14.6012 8.23154 14.7218C9.22766 15.8064 9.84103 16.7984 9.97308 18ZM10 20V21H14V20H10ZM5.75395 14.9992C4.65645 13.6297 4 11.8915 4 10C4 5.58172 7.58172 2 12 2C16.4183 2 20 5.58172 20 10C20 11.8925 19.3428 13.6315 18.2443 15.0014C17.624 15.7748 16 17 16 18.5V21C16 22.1046 15.1046 23 14 23H10C8.89543 23 8 22.1046 8 21V18.5C8 17 6.37458 15.7736 5.75395 14.9992Z" fill=currentColor></path></svg></div><div class=content><p>the address <code>0x8011d018</code> is included in the <a rel="nofollow noreferrer" href=https://smashboards.com/threads/smashboards-community-symbol-map.426763/>smashboards community symbol map</a>, given the name <code>_$_wP_Peach_DownB_GenTurnip</code> - looks like we're on the right track.</div></blockquote><h1 id=peach-downb-genturnip-logic>Peach_DownB_GenTurnip logic<a aria-label="Anchor link for: peach-downb-genturnip-logic" class=zola-anchor href=#peach-downb-genturnip-logic>#</a></h1><p>let's take a closer look at the logic around <code>0x8011d088</code> in the body of the function:<pre class=z-code><code><span class="z-text z-plain">...
8011d088: bl	->0x80380580
8011d08c: cmpwi	r3, 0
8011d090: bne-	 ->0x8011D0A0
8011d094: mr	r3, r29
8011d098: bl	->0x8011CE48
8011d09c: mr	r31, r3
8011d0a0: lwz	r4, 0x010C (r30)
8011d0a4: mr	r6, r31
8011d0a8: lfs	f1, 0x002C (r30)
8011d0ac: mr	r3, r29
8011d0b0: lwz	r4, 0x0008 (r4)
8011d0b4: lbz	r5, 0x0010 (r4)
8011d0b8: addi	r4, sp, 52
8011d0bc: bl	->0x802BD4AC
...
</span></code></pre><p>there's a few things happening here:<ul><li>we call <code>get_random_int(128)</code> (denoted by address <code>0x80380580</code>, with <code>r3</code> set to <code>128</code>),<li>when we return to the subroutine, <code>r3</code> is populated with the random return value<li>we check <code>r3</code> with the <code>cmpwi</code> instruction to see if the return value is 0,<li>if <em>the return value is not 0</em>, we branch to <code>0x8011d0a0</code> using the <code>bne</code> instruction<li>if <em>the return value is 0</em>, we continue execution.</ul><p>this maps directly to the explanation we saw in "The Basics of RNG in Melee" previously, but this time we're doing it live.<p>we can try stepping through the <code>get_random_int</code> call until we get to the return <code>blr</code> instruction at <code>0x803805b8</code>. if we check the value of the <code>r3</code> register, we can see the random result returned:<figure><img alt="r3 is returning 0x20" src=/img/r3-return.png><figcaption>0x20 == 32</figcaption></figure><p><code>32 != 0</code>, so this is going to be a turnip. but now that we know how this logic works...what if we got a little mischevious?<h1 id=giving-peach-a-buff>giving peach a buff<a aria-label="Anchor link for: giving-peach-a-buff" class=zola-anchor href=#giving-peach-a-buff>#</a></h1><p>navigate to the <code>cmpwi</code> instruction at <code>0x8011d08c</code>:<figure><img alt="cmpwi instruction" src=/img/cmpwi.png><figcaption>our fate is in our own hands</figcaption></figure><p>let's create a new breakpoint:<figure><img alt="cmpwi breakpoint conditions" src=/img/cmpwi-conditions.png><figcaption>this is not tournament legal</figcaption></figure><p>instead of using the returned value from the <code>get_random_int(128)</code> call, we're just going to set register <code>r3</code> to 0 when evaluating this instruction.<p>let's disable our previous breakpoint for now so we can test this out:<figure><img alt="disabling get_random_int breakpoint" src=/img/disable-old-breakpoint.png><figcaption>otherwise, our game stops on every item pull</figcaption></figure><p>hit start, and let's get pulling!<figure><img alt="peach is only throwing items" src=/img/buffed-peach.gif><figcaption>the dream</figcaption></figure><h1 id=final-destination-no-items-beamswords-only>final destination, no items, beamswords only<a aria-label="Anchor link for: final-destination-no-items-beamswords-only" class=zola-anchor href=#final-destination-no-items-beamswords-only>#</a></h1><p>i'm quite fond of beamswords, so let's see if we can make them a little more popular. if we refer to our charts from earlier, we expect that there will be a <code>get_random_int(6)</code> call. we can modify our <code>get_random_int</code> breakpoint condition accordingly:<figure><img alt="r3 == 6" src=/img/breakpoint-modify.png><figcaption>r3 == 6</figcaption></figure><p>if you've followed along this far, hopefully you're getting the hang of the dolphin debugger. hit the <code>LR == 8011cf0c</code> address in the callstack, a familiar <code>bl ->0x80380580</code> instruction. let's navigate to the <em>next instruction</em> (<code>0x8011cf10</code>) and create a new breakpoint, setting <code>r3 = 5</code> and continuing execution:<figure><img alt="r3 = 5" src=/img/mr-saturn-breakpoint.png><figcaption>r3 = 5</figcaption></figure><p>once again, let's disable our <code>get_rand_int</code> item RNG call:<figure><img alt="disabling item rng breakpoint" src=/img/disable-item-rng.png><figcaption>we're almost there</figcaption></figure><p>and finally:<figure><img alt="peach only pulls beamswords now" src=/img/sword-peach.gif><figcaption>watch out marth</figcaption></figure><h1 id=closing-thoughts>closing thoughts<a aria-label="Anchor link for: closing-thoughts" class=zola-anchor href=#closing-thoughts>#</a></h1><p>nothing here is novel - my goal is only to share the fun things i've been learning about recently. i spend much of my time working towards understanding through experimentation, and i'm hoping this blog can serve as a lab notebook.<p>if you have any questions, comments, or corrections, feel free to send me an email at <a href=mailto:djanatyn@gmail.com>djanatyn@gmail.com</a>. thanks for taking the time to read, take care!</article></div><footer><div class=copyright><p>by djan</div><div class=credits>powered by <a rel="noreferrer noopener" href=https://www.getzola.org target=_blank>zola</a> and <a rel="noreferrer noopener" href=https://github.com/isunjn/serene target=_blank>serene</a></div></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>